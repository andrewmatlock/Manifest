<h2>Teams</h2>

<!-- Create team -->
<div class="row-wrap gap-2">

    <div role="group">
        <input type="text" placeholder="New team name" class="peer" x-model="$auth.newTeamName"
            :disabled="$auth.isCreatingTeam()" />
        <button @click="$auth.createTeamFromName()" :disabled="!$auth.newTeamName || $auth.isCreatingTeam()"
            class="peer-invalid:disabled">Create Team</button>
    </div>

    <!-- Add back deleted template teams -->
    <template x-for="teamName in $auth.deletedTemplateTeams" :key="teamName">
        <button @click="$auth.reapplyTemplateTeam(teamName)" :disabled="$auth.isCreatingTeam()">Create
            <b x-text="teamName"></b></button>
    </template>

    <!-- No teams content -->
    <small x-show="!$auth.teams || $auth.teams.length === 0" class="text-sm text-muted">No teams yet</small>

</div>

<div>

    <!-- Team list -->
    <template x-for="team in $auth.teams" :key="team.$id">

        <!-- Team accordion-->
        <details class="pb-4 open:p-4 open:bg-surface-1 relative" x-data="{ 
                loaded: false, 
                editingTeamName: team.name,
                presenceSubscription: null,
                presenceCursors: [],
                async initPresence() {
                    if (!window.ManifestDataPresence || !$auth.user) return;
                    try {
                        // Get databaseId from manifest
                        const manifest = await window.ManifestDataConfig?.ensureManifest?.();
                        const presenceConfig = manifest?.data?.presence;
                        if (!presenceConfig?.appwriteDatabaseId) {
                            console.warn('[Presence] Database ID not found in manifest');
                            return;
                        }
                        // Subscribe to presence for this team
                        const teamElement = $el;
                        this.presenceSubscription = await window.ManifestDataPresence.subscribeToPresence(
                            `team-${team.$id}`,
                            {
                                element: teamElement,
                                databaseId: presenceConfig.appwriteDatabaseId,
                                tableId: presenceConfig.appwriteTableId || 'presence',
                                onCursorUpdate: (cursors) => {
                                    this.presenceCursors = cursors;
                                },
                                onUserJoin: ({ userId, name, color }) => {
                                    console.log('[Presence] User joined:', name);
                                },
                                onUserLeave: ({ userId }) => {
                                    console.log('[Presence] User left:', userId);
                                }
                            }
                        );
                        // Handle null return (subscription failed)
                        if (!this.presenceSubscription) {
                            console.warn('[Presence] Subscription returned null - presence may not be available');
                            this.presenceSubscription = null;
                        }
                    } catch (error) {
                        console.error('[Presence] Failed to initialize:', error);
                        this.presenceSubscription = null;
                    }
                },
                cleanupPresence() {
                    if (this.presenceSubscription && typeof this.presenceSubscription.unsubscribe === 'function') {
                        try {
                            this.presenceSubscription.unsubscribe();
                        } catch (error) {
                            console.warn('[Presence] Error during cleanup:', error);
                        }
                    }
                    this.presenceSubscription = null;
                    this.presenceCursors = [];
                }
            }" x-effect="editingTeamName = team.name" @toggle="if ($event.target.open && !loaded) { 
                $auth.currentTeam = team; 
                $auth.viewTeam(team); 
                loaded = true;
                if (!$el.presenceInitialized) {
                    $el.presenceInitialized = true;
                    $nextTick(() => initPresence());
                }
            } else if (!$event.target.open) {
                cleanupPresence();
                $el.presenceInitialized = false;
            }">

            <!-- Team name input / expand button -->
            <summary class="row gap-4" x-data="{ icon: 'lucide:circle' }">
                <!-- Team selection -->
                <input type="checkbox" :checked="$auth.currentTeam?.$id === team.$id"
                    :disabled="$auth.currentTeam?.$id === team.$id"
                    @click.stop="$auth.currentTeam = team; $auth.viewTeam(team)" />
                <!-- Team name input -->
                <input type="text" placeholder="Insert name" class="transparent hug flex-1" onclick="this.select()"
                    x-model="editingTeamName" :disabled="!$auth.isTeamRenamable(team) || $auth.isUpdatingTeam(team.$id)"
                    @blur="if (editingTeamName !== team.name && editingTeamName.trim()) { $auth.updateTeamName(team.$id, editingTeamName.trim()); }"
                    @keydown.enter="$event.target.blur()" />
            </summary>

            <!-- Team content -->
            <div class="row-wrap gap-8 pt-8">

                <!-- Team settings -->
                <div class="relative col gap-4 w-50 max-w-full flex-1">

                    <!-- Duplicate team -->
                    <button class="sm absolute sm top-0 end-12"
                        @click="$auth.duplicateTeam(team.$id, { copyMembers: false, copyRoles: false }).then(result => { if (result.success) { console.log('Team duplicated:', result.team); } else { alert('Failed to duplicate team: ' + result.error); } })"
                        :disabled="$auth._duplicatingTeam === team.$id" aria-label="Duplicate team"
                        x-icon="lucide:copy">Duplicate</button>

                    <!-- Delete team -->
                    <button class="sm absolute sm top-0 end-0" @click="$auth.deleteTeam(team.$id)"
                        :disabled="$auth.isActionDisabled('deleteTeam') || !$auth.isTeamDeletable(team) || $auth.isDeletingTeam(team.$id)"
                        aria-label="Delete team" x-icon="lucide:trash">Delete Team</button>

                    <!-- Static Info -->
                    <div class="col gap-1">
                        <small>ID: <b x-text="team.$id"></b></small>
                        <small>Created: <b x-text="$auth.teamCreatedAt(team)"></b></small>
                        <small>Modified: <b x-text="$auth.teamUpdatedAt(team)"></b></small>
                    </div>

                    <hr>

                    <!-- Roles & Permissions -->
                    <div class="col gap-4">
                        <small>Roles & Permissions</small>

                        <!-- List -->
                        <template x-for="(permissions, roleName) in $auth.allTeamRoles(team)" :key="roleName">
                            <div class="relative row gap-2 items-center max-w-full"
                                x-data="{ editingRoleName: roleName, customPermInput: '', isSaving: false, saveTimeout: null, pendingPermissions: null, get isUpdating() { return $auth.isUpdatingRole(team.$id, roleName); } }"
                                x-effect="editingRoleName = roleName">

                                <!-- Role name input -->
                                <input type="text" class="transparent hug flex-1" x-model="editingRoleName"
                                    @blur="if (isSaving || isUpdating) return; if (editingRoleName !== roleName && editingRoleName.trim()) { isSaving = true; $auth.startEditingRole(team.$id, roleName); if ($auth.editingRole) { $auth.editingRole.newRoleName = editingRoleName.trim(); } $auth.saveEditingRole().then(() => { isSaving = false; }); }"
                                    @keydown.enter="$event.target.blur()"
                                    :disabled="$auth.isActionDisabled('manageRoles') || ($auth.isRolePermanentSync && $auth.isRolePermanentSync(team.$id, roleName)) || isUpdating" />

                                <!-- Permissions dropdown button -->
                                <button class="sm flex-1" x-dropdown="`permissions-menu-${team.$id}-${roleName}`"
                                    :disabled="$auth.isActionDisabled('manageRoles') || ($auth.isRolePermanentSync && $auth.isRolePermanentSync(team.$id, roleName)) || isUpdating">
                                    <span
                                        x-text="(pendingPermissions && pendingPermissions.length > 0) ? pendingPermissions.join(', ') : ((permissions && permissions.length > 0) ? permissions.join(', ') : 'No permissions')"></span>
                                    <i class="trailing" x-icon="lucide:chevron-down"></i> </button>

                                <!-- Permissions dropdown -->
                                <menu popover :id="`permissions-menu-${team.$id}-${roleName}`"
                                    x-init="if (!$auth.allAvailablePermissions || $auth.allAvailablePermissions.length === 0) { $auth.getAllAvailablePermissions(team.$id).then(perms => { $auth.allAvailablePermissions = perms; }); }">
                                    <template x-for="permission in $auth.allAvailablePermissions || []"
                                        :key="permission">
                                        <label>
                                            <input type="checkbox"
                                                :checked="permissions && permissions.includes(permission)"
                                                @change="if (isSaving || isUpdating) return; isSaving = true; const updated = permissions ? [...permissions] : []; if ($event.target.checked) { if (!updated.includes(permission)) updated.push(permission); } else { const idx = updated.indexOf(permission); if (idx > -1) updated.splice(idx, 1); } pendingPermissions = updated; $auth.startEditingRole(team.$id, roleName).then(() => { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { if ($auth.editingRole && $auth.editingRole.teamId === team.$id && $auth.editingRole.oldRoleName === roleName && pendingPermissions) { await $auth.saveEditingRole(pendingPermissions); pendingPermissions = null; } isSaving = false; }, 300); });"
                                                :disabled="!$auth.canManageRoles() || ($auth.isRolePermanentSync && $auth.isRolePermanentSync(team.$id, roleName)) || isSaving || isUpdating" />
                                            <span x-text="permission"></span>
                                        </label>
                                    </template>
                                    <input type="text" placeholder="Custom permission" aria-label="Custom permission"
                                        x-model="customPermInput"
                                        @keydown.enter.prevent="if (isSaving || isUpdating) return; if (customPermInput.trim()) { isSaving = true; const updated = permissions ? [...permissions] : []; if (!updated.includes(customPermInput.trim())) { updated.push(customPermInput.trim()); pendingPermissions = updated; $auth.startEditingRole(team.$id, roleName).then(() => { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(async () => { if ($auth.editingRole && $auth.editingRole.teamId === team.$id && $auth.editingRole.oldRoleName === roleName && pendingPermissions) { await $auth.saveEditingRole(pendingPermissions); pendingPermissions = null; customPermInput = ''; } isSaving = false; }, 300); }); } }"
                                        :disabled="$auth.isActionDisabled('manageRoles') || ($auth.isRolePermanentSync && $auth.isRolePermanentSync(team.$id, roleName)) || isSaving || isUpdating" />
                                </menu>

                                <!-- Delete button -->
                                <button class="sm" @click="$auth.deleteUserRole(team.$id, roleName)"
                                    :disabled="$auth.isActionDisabled('manageRoles') || !$auth.isRoleDeletable(team.$id, roleName) || $auth.isDeletingRole(team.$id, roleName) || isUpdating"
                                    aria-label="Delete role" x-icon="lucide:trash"></button>
                            </div>
                        </template>

                        <!-- Create Role -->
                        <div class="row-wrap gap-2 mb-2" x-data="{ customPermInput: '' }">
                            <input type="text" placeholder="Role name" class="w-full" x-model="$auth.newRoleName"
                                :disabled="$auth.isActionDisabled('manageRoles') || $auth.isCreatingRole()" />
                            <button class="flex-1" x-dropdown="`permissions-menu-${team.$id}`"
                                :disabled="$auth.isActionDisabled('manageRoles') || $auth.isCreatingRole()">
                                <span
                                    x-text="($auth.newRolePermissions && $auth.newRolePermissions.length > 0) ? $auth.newRolePermissions.join(', ') : 'Permissions'"></span>
                                <i class="trailing" x-icon="lucide:chevron-down"></i>
                            </button>

                            <!-- Permissions dropdown-->
                            <menu popover :id="`permissions-menu-${team.$id}`">
                                <template x-for="permission in $auth.allAvailablePermissions || []" :key="permission">
                                    <label>
                                        <input type="checkbox" :checked="$auth.isPermissionSelected(permission)"
                                            @change="$auth.togglePermission(permission)"
                                            :disabled="!$auth.canManageRoles() || $auth.isCreatingRole()" />
                                        <span x-text="permission"></span>
                                    </label>
                                </template>
                                <input type="text" placeholder="Custom permission" aria-label="Custom permission"
                                    x-model="customPermInput"
                                    @keydown.enter.prevent="$auth.addCustomPermissions(customPermInput); customPermInput = ''"
                                    :disabled="$auth.isActionDisabled('manageRoles') || $auth.isCreatingRole()" />
                            </menu>

                            <button @click="$auth.createRoleFromInputs(team.$id)"
                                :disabled="!$auth.newRoleName || $auth.isActionDisabled('manageRoles') || $auth.isCreatingRole()"
                                class="w-fit">Create</button>
                        </div>

                    </div>

                    <hr>

                    <!-- Members-->
                    <div class="col gap-4">
                        <small>Members</small>

                        <!-- List -->
                        <template x-for="membership in $auth.currentTeamMemberships" :key="membership.$id">
                            <div class="row gap-3">
                                <div class="flex-1 col">
                                    <small>
                                        <b x-text="$auth.getMemberDisplayName(membership)"></b>
                                        <span x-show="membership.userId === $auth.user?.$id"> (You)</span>
                                    </small>
                                    <small x-text="$auth.getMemberEmail(membership)"></small>
                                </div>
                                <!-- Role dropdown and actions -->
                                <div class="row gap-1 items-center">
                                    <!-- Role dropdown -->
                                    <button class="sm" x-dropdown="`member-role-menu-${team.$id}-${membership.$id}`"
                                        :disabled="(membership.userId !== $auth.user?.$id && ($auth.isActionDisabled('updateMembers') || !$auth.canUpdateMembers())) || $auth.isUpdatingMember(membership.$id)"
                                        x-show="membership.userId === $auth.user?.$id || $auth.canUpdateMembers()">
                                        <span
                                            x-text="(membership.displayRoles && membership.displayRoles.length > 0) ? membership.displayRoles[0] : 'No role'"></span>
                                        <i class="trailing" x-icon="lucide:chevron-down"></i>
                                    </button>

                                    <!-- Role dropdown menu -->
                                    <menu popover :id="`member-role-menu-${team.$id}-${membership.$id}`">
                                        <template x-for="(permissions, roleName) in $auth.allTeamRoles(team)"
                                            :key="roleName">
                                            <label class="row items-center gap-2 cursor-pointer">
                                                <input type="radio" :name="`member-role-${team.$id}-${membership.$id}`"
                                                    :value="roleName"
                                                    :checked="(membership.displayRoles && membership.displayRoles.length > 0 && membership.displayRoles[0] === roleName)"
                                                    @change="$auth.updateMembership(team.$id, membership.$id, [roleName])"
                                                    :disabled="$auth.isUpdatingMember(membership.$id) || (membership.userId !== $auth.user?.$id && $auth.isActionDisabled('updateMembers'))" />
                                                <span x-text="roleName"></span>
                                            </label>
                                        </template>
                                    </menu>

                                    <!-- Delete button (for other members) -->
                                    <button class="sm" @click="$auth.deleteMember(team.$id, membership.$id)"
                                        :disabled="$auth.isActionDisabled('removeMembers') || $auth.isDeletingMember(membership.$id)"
                                        aria-label="Remove member" x-icon="lucide:trash"
                                        x-show="membership.userId !== $auth.user?.$id && $auth.canRemoveMembers()"></button>
                                    <!-- Leave button (for current user) -->
                                    <button class="sm" @click="$auth.leaveTeam(team.$id, membership.$id)"
                                        :disabled="$auth.isDeletingMember(membership.$id)" aria-label="Leave team"
                                        x-icon="lucide:log-out" x-show="membership.userId === $auth.user?.$id"></button>

                                </div>
                            </div>
                        </template>

                        <!-- Invite Member -->
                        <div class="row-wrap gap-2 mb-2" x-data="{ customRoleInput: '' }">
                            <input type="email" placeholder="Email" class="w-full" x-model="$auth.inviteEmail"
                                :disabled="$auth.isActionDisabled('inviteMembers') || $auth.isInvitingMember()"
                                required />
                            <button class="flex-1" x-dropdown="`invite-roles-menu-${team.$id}`"
                                :disabled="$auth.isActionDisabled('inviteMembers') || $auth.isInvitingMember()">
                                <span
                                    x-text="($auth.inviteRoles && $auth.inviteRoles.length > 0) ? $auth.inviteRoles.join(', ') : 'Roles'"></span>
                                <i class="trailing" x-icon="lucide:chevron-down"></i>
                            </button>

                            <!-- Roles dropdown-->
                            <menu popover :id="`invite-roles-menu-${team.$id}`">
                                <template x-for="(permissions, roleName) in $auth.allTeamRoles(team)" :key="roleName">
                                    <label>
                                        <input type="checkbox" :checked="$auth.isInviteRoleSelected(roleName)"
                                            @change="$auth.toggleInviteRole(roleName)"
                                            :disabled="!$auth.canInviteMembers() || $auth.isInvitingMember()" />
                                        <span x-text="roleName"></span>
                                    </label>
                                </template>
                                <input type="text" placeholder="Custom role" aria-label="Custom role"
                                    x-model="customRoleInput"
                                    @keydown.enter.prevent="$auth.addCustomInviteRoles(customRoleInput); customRoleInput = ''"
                                    :disabled="$auth.isActionDisabled('inviteMembers') || $auth.isInvitingMember()" />
                            </menu>

                            <button @click="$auth.inviteToCurrentTeam()"
                                :disabled="!$auth.inviteEmail || $auth.isActionDisabled('inviteMembers') || !team || $auth.isInvitingMember()"
                                class="w-fit">Invite</button>
                        </div>

                    </div>

                </div>

                <!-- Projects -->
                <x-appwrite-projects></x-appwrite-projects>

            </div>

            <!-- Presence indicators -->
            <div class="absolute top-2 end-2 col gap-1" x-show="presenceCursors.length > 0">
                <small class="text-xs text-muted">Active users:</small>
                <template x-for="cursor in presenceCursors" :key="cursor.name">
                    <div class="row gap-1 items-center text-xs">
                        <span class="w-2 h-2 rounded-full" :style="`background-color: ${cursor.color}`"></span>
                        <span x-text="cursor.name"></span>
                    </div>
                </template>
            </div>
        </details>
    </template>

</div>