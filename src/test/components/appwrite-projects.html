<!-- Projects -->
<div class="col gap-4 w-50 max-w-full flex-1">

    <!-- Create Project -->
    <div role="group">
        <input type="text" placeholder="Project name" x-model="newName"
            :disabled="!$auth.currentTeam || projectsError" />
        <input type="text" placeholder="Project type" x-model="newType" :disabled="!$auth.currentTeam || projectsError"
            class="w-30" />
        <button
            @click="if (newName && newType && $auth.currentTeam) { $x.projects.$create({ name: newName, type: newType }).then(() => { newName = ''; newType = ''; }); }"
            :disabled="!newName || !newType || !$auth.currentTeam || $x.projects.$error">Create
            Project</button>
    </div>

    <!-- Projects error message -->
    <small x-show="$x.projects.$loading">Projects loading...</small>
    <small x-show="$x.projects.$error" x-text="$x.projects.$error"></small>
    <small x-show="$x.projects.$ready && !$x.projects.$loading && !$x.projects.$error">Projects
        Ready</small>

    <!-- Projects list -->
    <div x-show="$x.projects && Array.isArray($x.projects) && $x.projects.length > 0" class="col gap-2">
        <template x-for="project in $x.projects" :key="project.$id">
            <div class="relative p-4 bg-surface-2" x-data="{
                    editingProjectName: project.name,
                    editingProjectType: project.type,
                    project: project,
                    
                    // Generic field update helper
                    updateField(field, value) {
                        if (value !== this.project[field] && value.trim()) {
                            $x.projects.$update(this.project.$id, { [field]: value.trim() });
                        }
                    },
                    
                    // File operations
                    async handleFileUpload(projectId, event) {
                        await window.$x.projects.$upload(projectId, event);
                    },
                    async handleFileDelete(file, project) {
                        if (confirm('Delete ' + (file.name || 'this file') + '?')) {
                            await window.$x.assets.$delete(file.$id);
                            await window.$x.projects.$update(project.$id, { fileIds: (project.fileIds || []).filter(id => id !== file.$id) });
                        }
                    },
                    
                    // Scope label helper
                    getScopeLabel() {
                        if (this.project.userId && this.project.userId === ($auth.user?.$id || $auth.user?.id)) return 'Users';
                        if (this.project.teamId && this.project.teamId === ($auth.currentTeam?.$id || $auth.currentTeam?.id)) return 'Current Team';
                        if (this.project.teamId) return 'Other Team';
                        return 'No Scope';
                    }
                }"
                x-init="const cleanup = window.ManifestDataMutations?.setupEventDrivenReactivity?.(this, 'projects', project.$id); editingProjectName = project.name; editingProjectType = project.type; $watch(() => Alpine.store('data').projects, (projects) => { if (Array.isArray(projects)) { const updatedProject = projects.find(p => p.$id === project.$id); if (updatedProject) { project = updatedProject; editingProjectName = project.name; editingProjectType = project.type; } } }); $el.addEventListener('alpine:destroy', () => { if (cleanup) cleanup(); });">
                <div class="col gap-3">

                    <!-- Duplicate project -->
                    <button class="sm absolute sm top-4 end-32"
                        @click="$x.projects.$duplicate(project.$id, { files: 'same' }).then(result => { console.log('Project duplicated:', result); }).catch(err => { console.error('Duplicate error:', err); alert('Failed to duplicate project: ' + (err.message || err)); })"
                        aria-label="Duplicate project" x-icon="lucide:copy">Duplicate</button>

                    <!-- Delete project -->
                    <button class="sm absolute sm top-4 end-4"
                        @click="if (confirm('Delete project?')) { $x.projects.$delete(project.$id); }"
                        aria-label="Delete project" x-icon="lucide:trash">Delete Project</button>

                    <!-- Project Header -->
                    <div class="col gap-2">

                        <!-- Project name input -->
                        <input type="text" placeholder="Project name" class="transparent hug font-semibold"
                            onclick="this.select()" x-model="editingProjectName"
                            @blur="updateField('name', editingProjectName)" @keydown.enter="$event.target.blur()" />

                        <!-- Project type input -->
                        <input type="text" placeholder="Project type" class="transparent hug text-sm text-muted"
                            onclick="this.select()" x-model="editingProjectType"
                            @blur="updateField('type', editingProjectType)" @keydown.enter="$event.target.blur()" />

                        <!-- Details -->
                        <figcaption>ID: <b x-text="project.$id"></b></figcaption>
                        <figcaption>Created: <b x-text="new Date(project.$createdAt).toLocaleString()"></b>
                        </figcaption>
                        <figcaption>Scope: <b x-text="getScopeLabel()"></b></figcaption>

                        <!-- File Upload -->
                        <div class="row justify-between items-center gap-4">
                            <small x-show="(project.fileIds || []).length > 0">
                                <b x-text="(project.fileIds || []).length"></b> <span
                                    x-text="(project.fileIds || []).length === 1 ? 'file' : 'files'"></span>
                            </small>
                            <label role="button" class="sm w-fit">
                                <input type="file" @change="handleFileUpload(project.$id, $event)" accept="*/*" />
                                <i x-icon="lucide:upload"></i>
                            </label>
                        </div>

                        <!-- Project Files List -->
                        <div class="col gap-2 pt-2">
                            <small x-show="project.$filesLoading">Loading files...</small>
                            <small x-show="project.$filesError" class="text-error text-sm"
                                x-text="project.$filesError"></small>
                            <small
                                x-show="!project.$filesLoading && !project.$filesError && (!project.$files || project.$files.length === 0)">No
                                files</small>

                            <!-- Files List -->
                            <div x-show="project.$files && project.$files.length > 0 && !project.$filesLoading"
                                class="col gap-2">
                                <template x-for="(file, index) in project.$files" :key="file.$id || index">
                                    <div class="row gap-2 items-center w-full p-2 bg-surface-1 rounded">

                                        <!-- Preview Thumbnail (for images) -->
                                        <div x-show="file.$isImage" class="flex-shrink-0">
                                            <img x-show="file.$thumbnailUrl" :src="file.$thumbnailUrl"
                                                :alt="file.name || 'Preview'" class="w-12 h-12 object-cover rounded"
                                                @error="$el.style.display = 'none'" loading="lazy" />
                                            <div x-show="file.$thumbnailError"
                                                class="w-12 h-12 bg-surface-3 rounded flex items-center justify-center"
                                                title="Thumbnail error">
                                                <small class="text-xs text-muted">Error</small>
                                            </div>
                                            <div x-show="file.$thumbnailLoading"
                                                class="w-12 h-12 bg-surface-3 rounded flex items-center justify-center">
                                                <small class="text-xs text-muted">Loading...</small>
                                            </div>
                                        </div>

                                        <!-- File Info -->
                                        <div class="col gap-1 flex-1 min-w-0">
                                            <figcaption class="truncate text-sm font-semibold"
                                                x-text="file.name || 'Unnamed file'"></figcaption>
                                            <div class="row-wrap gap-2 text-xs text-muted">
                                                <small x-show="file.$formattedSize">
                                                    <span x-text="file.$formattedSize"></span>
                                                </small>
                                                <small x-show="file.mimeType">
                                                    <span x-text="file.mimeType.split('/')[1]"></span>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="row gap-1 ms-auto">
                                            <!-- Preview (for images) -->
                                            <button class="sm" x-show="file.$isImage"
                                                @click="$x.assets.$openPreview(file.$id, { width: 800, height: 800 })"
                                                x-icon="lucide:eye" title="Preview">
                                            </button>

                                            <!-- View URL -->
                                            <button class="sm" @click="$x.assets.$openUrl(file.$id)"
                                                x-icon="lucide:external-link" title="View URL">
                                            </button>

                                            <!-- Download -->
                                            <button class="sm" @click="$x.assets.$openDownload(file.$id, file.name)"
                                                x-icon="lucide:download" title="Download">
                                            </button>

                                            <!-- Duplicate -->
                                            <button class="sm" @click="$x.assets.$duplicate(file.$id).then(duplicatedFile => { 
                                                    if (duplicatedFile && duplicatedFile.$id) {
                                                        const currentFileIds = project.fileIds || [];
                                                        $x.projects.$update(project.$id, { 
                                                            fileIds: [...currentFileIds, duplicatedFile.$id] 
                                                        });
                                                    }
                                                }).catch(err => { 
                                                    console.error('Duplicate error:', err); 
                                                    alert('Failed to duplicate file: ' + (err.message || err)); 
                                                })" x-icon="lucide:copy" title="Duplicate file">
                                            </button>

                                            <!-- Delete -->
                                            <button class="sm" @click="handleFileDelete(file, project)"
                                                x-icon="lucide:trash" title="Delete file">
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>